
- name: Maak gebruikers en genereer SSH-sleutels
  hosts:
    - pm01
    - pm02
    - pm03
  vars:
    users:
      - username: numbero_uno
        pubkey_file: numbero_uno.pub
      - username: numbero_dos
        pubkey_file: numbero_dos.pub

  tasks:
    - name: Maak gebruikers aan
      user:
        name: "{{ item.username }}"
        createhome: yes
      with_items: "{{ users }}"

    - name: Create .ssh directory
      file:
        path: "/home/{{ item.username }}/.ssh"
        state: directory
      with_items: "{{ users }}"

    - name: Genereer SSH-sleutels
      openssh_keypair:
        path: "/home/{{ item.username }}/.ssh/id_rsa"
        state: present
      with_items: "{{ users }}"



    - name: Voeg publieke sleutels toe aan authorized_keys
      authorized_key:
        user: "{{ item.username }}"
        key: "{{ lookup('file', item.pubkey_file) }}"
      with_items: "{{ users }}"


###
### EspoCRM installatie
####