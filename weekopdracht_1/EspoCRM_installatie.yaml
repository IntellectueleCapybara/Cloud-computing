###
### EspoCRM installatie
###

- name: Voeg CIFS gedeelde opslag toe aan Proxmox
  hosts:
    - pm01
    - pm02
    - pm03
  vars_prompt:
    - name: cifs_password
      prompt: "Voer het wachtwoord in voor CIFS gedeelde opslag"
      private: yes
  tasks:

    - name: Controleer of CIFS gedeelde opslag al bestaat
      shell: cat /etc/pve/storage.cfg | grep shared_storage
      register: shared_storage_check
      ignore_errors: yes

    - name: Voer het pvesm commando uit om CIFS gedeelde opslag toe te voegen
      command: pvesm add cifs shared_storage --server 172.16.0.100 --share 422422 --username student422422 --password "{{ cifs_password }}"
      when: shared_storage_check.stdout == ""

    - name: Add entry to /etc/fstab for shared storage
      lineinfile:
        path: /etc/fstab
        line: "//172.16.0.100/shared_storage /shared_storage cifs username=student422422,password={{ cifs_password }},rw 0 0"
        state: present
      when: "not (lookup('file', '/etc/fstab') | regex_search('172.16.0.100/shared_storage'))"
    
- name: Automate EspoCRM Deployment
  hosts: localhost
  gather_facts: no
  become: yes

###
### vars gebruiken zodat dit script ook scalable is
###

  vars: #verander dit als je andere IPs hebt en andere nodenamen
    pm01: 172.16.39.70
    pm02: 172.16.39.71
    pm03: 172.16.39.72
    node1: geenboom2
    node2: geenboom3
    node3: geenboom4


###
### Wachtwoorden prompten zodat hij niet hardcoded in het script staat
###

  vars_prompt:
    - name: "api_password"
      prompt: "Enter the Proxmox API password"
      private: yes

  tasks:
    - name: Updaten van packets...
      apt:
        update_cache: yes

    - name: Install Python 3 and pip
      become: yes
      become_user: root
      command: apt install -y python3 python3-pip

    - name: Installeer proxmoxer en requests met pip
      ansible.builtin.pip:
        name:
          - proxmoxer
          - requests
        executable: pip3

    - name: installeren van community.general collectie
      ansible.builtin.command:
        cmd: ansible-galaxy collection install community.general

##
##EspoCRM VMs aanmaken met disk 50G/2 proc/2GB mem ne statische IP toekennen
##
    ###
    ### PM01
    ###
    - name: Create VMs on pm01
      proxmox_kvm:
        api_user: root@pam
        api_password: "{{ api_password }}"
        api_host: "{{ pm01 }}"
        node: "{{ node1 }}"
        name: "{{ item.hostname }}"
        clone: ubuntu-2004-cloudinit-template
        newid: "{{ item.vmid }}"
        memory: 2048
        cores: 2
        net: '{"net0":"virtio,bridge=vmbr0"}'
        virtio: '{"virtio0":"shared_storage:50,format=qcow2"}'
        onboot: yes
        ostype: l26 # Ubuntu 20.04 LTS
        ipconfig: '{"ipconfig0":"ip={{ item.ip }}/16,gw=172.16.0.1"}'
        agent: '1'
      loop:
        - { vmid: 100, hostname: "espocrmvm1", ip: "172.16.39.100" }

    ##
    ## PM02
    ##

    - name: Create VMs on pm02
      proxmox_kvm:
        api_user: root@pam
        api_password: "{{ api_password }}"
        api_host: "{{ pm02 }}"
        node: "{{ node2 }}"
        name: "{{ item.hostname }}"
        clone: ubuntu-2004-cloudinit-template
        newid: "{{ item.vmid }}"
        memory: 2048
        cores: 2
        net: '{"net0":"virtio,bridge=vmbr0"}'
        virtio: '{"virtio0":"shared_storage:50,format=qcow2"}'
        onboot: yes
        ostype: l26 # Ubuntu 20.04 LTS
        ipconfig: '{"ipconfig0":"ip={{ item.ip }}/16,gw=172.16.0.1"}'
        agent: '1'
      loop:
        - { vmid: 101, hostname: "espocrmvm2", ip: "172.16.39.101" }

    ###
    ### PM03
    ###

    - name: Create VMs on pm03
      proxmox_kvm:
        api_user: root@pam
        api_password: "{{ api_password }}"
        api_host: "{{ pm03 }}"
        node: "{{ node3 }}"
        name: "{{ item.hostname }}"
        clone: ubuntu-2004-cloudinit-template
        newid: "{{ item.vmid }}"
        memory: 2048
        cores: 2
        net: '{"net0":"virtio,bridge=vmbr0"}'
        virtio: '{"virtio0":"shared_storage:50,format=qcow2"}'
        onboot: yes
        ostype: l26 # Ubuntu 20.04 LTS
        ipconfig: '{"ipconfig0":"ip={{ item.ip }}/16,gw=172.16.0.1"}'
        agent: '1'
      loop:
        - { vmid: 102, hostname: "espocrmvm3", ip: "172.16.39.102" }



###
### espocrm_vms groep aanmaken
###

    - name: espocrm_vms group maken
      add_host:
        name: "{{ item.hostname }}"
        groups: espocrm_vms
        node: "{{ item.node }}"
        vmid: "{{ item.vmid }}"
        ip: "{{ item.ip }}"
      loop:
        - { node: "pm01", vmid: 100, hostname: "espocrmvm1", ip: "172.16.39.101" }
        - { node: "pm02", vmid: 101, hostname: "espocrmvm2", ip: "172.16.39.102" }
        - { node: "pm03", vmid: 102, hostname: "espocrmvm3", ip: "172.16.39.103" }

    - name: VMs tevoegen aan hosts file
      lineinfile:
        path: /home/geenboom1/ansible_wordpress_project/hosts
        line: "\n[{{ item.hostname }}]\n{{ item.ip }}"
        state: present
      become: yes
      loop:
        - { hostname: "espocrmvm1", ip: "172.16.39.101" }
        - { hostname: "espocrmvm2", ip: "172.16.39.102" }
        - { hostname: "espocrmvm3", ip: "172.16.39.103" }

###
### de VMs starten
###
- name: VM starten op Proxmox 1
  hosts: pm01
  become: yes
  tasks:
    - name: Start VM on pm01
      shell: "qm status 100 | grep -q 'status: running' || qm start 100"

- name: VM starten op Proxmox 2
  hosts: pm02
  become: yes
  tasks:
    - name: Start VM on pm02
      shell: "qm status 101 | grep -q 'status: running' || qm start 101"

- name: VM starten op Proxmox 3
  hosts: pm03
  become: yes
  tasks:
    - name: Start VM on pm03
      shell: "qm status 102 | grep -q 'status: running' || qm start 102"

###
### de VMs wachten tot ze gestart zijn
###

- name: Automate EspoCRM Deployment
  hosts: localhost
  gather_facts: no
  become: yes
  tasks:
    - name: Wait for VMs to boot
      local_action:
        module: wait_for
        host: "{{ item }}"
        port: 22
        delay: 5
        timeout: 60
        state: started
      with_items:
        - "espocrmvm1"
        - "espocrmvm2"
        - "espocrmvm3"

###
### de VMs updaten en rebooten
###

    - name: Update VMs
      apt:
        update_cache: yes
      delegate_to: "{{ item }}"
      with_items:
        - "espocrmvm1"
        - "espocrmvm2"
        - "espocrmvm3"

    - name: Reboot VMs
      shell: reboot
      delegate_to: "{{ item }}"
      with_items:
        - "espocrmvm1"
        - "espocrmvm2"
        - "espocrmvm3"
      async: 1
      poll: 0

    - name: Wait for VMs to reboot
      local_action:
        module: wait_for
        host: "{{ item }}"
        port: 22
        delay: 5
        timeout: 180
        state: started
      with_items:
        - "espocrmvm1"
        - "espocrmvm2"
        - "espocrmvm3"

    - name: Configure HA for VMs
      command:
        cmd: "pvecm add {{ item }}"
      loop:
        - "pm01"
        - "pm02"
        - "pm03"
###
### Twee keer per dag moet er een snapshot van de VM worden gemaakt.
###

- name: Create snapshot script on Proxmox hosts
  hosts: pm01,pm02,pm03
  become: yes
  tasks:
    - name: Create snapshot script
      copy:
        dest: "/root/snapshot_vms.sh"
        content: |
          #!/bin/bash
          for vmid in 100 101 102; do
            pct snapshot $vmid daily_snapshot
          done
        mode: 0755

    - name: Create cron job for snapshotting VMs twice a day
      cron:
        name: "snapshot job"
        minute: "0"
        hour: "*/12"
        job: "/root/snapshot_vms.sh"

    - name: monitor server toevoegen
      shell: wget -O /tmp/netdata-kickstart.sh https://my-netdata.io/kickstart.sh && sh /tmp/netdata-kickstart.sh --nightly-channel --claim-token _ExXqLL6xuhgP-in2_scLbHnb9CpJhFWdyRDv0_9va-y0oDh_7C1nIzPYKTrswU_jjBaTVyw3uDv9HZEOwJDLAr3GPN77vDROxZRyTiTpenkwEiBZSb_BoNBOp9iFXMdPljhxvY --claim-rooms 07aa6c7e-53f3-4ba3-a3b2-96ce6bf53001 --claim-url https://app.netdata.cloud


- name: EspoCRM VMs instellen
  hosts: espocrm_vms
  become: yes

  tasks:

###
### installeren van espocrm op de vms
###

    - name: Check if EspoCRM is installed
      stat:
        path: /path/to/espocrm
      register: espocrm_dir

    - name: Install espocrm on the VMs
      shell: |
        wget https://github.com/espocrm/espocrm-installer/releases/latest/download/install.sh
        sudo bash install.sh -y --ssl --letsencrypt --domain=cloud-espocrm.com --clean
      args:
        chdir: /root
      register: espocrm_install
      when: not espocrm_dir.stat.exists

    - debug:
        var: espocrm_install.stdout_lines




