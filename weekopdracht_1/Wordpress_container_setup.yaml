- name: Installeren van Docker op de cluster...
  hosts: pm01
  become: true
  tasks:
    - name: Updaten van packets...
      apt:
        update_cache: yes

    - name: Installeren van Docker...
      apt:
        name: docker.io
        state: present

    - name: Start Docker-service
      service:
        name: docker
        state: started

- name: CreÃ«eren van de Containers met wordpress...
  hosts: pm01
  tasks:
    - name: 10 Wordpress Containers aan het maken...
      command: >
        docker run -d --name my_wordpress_container_{{ item }}
        --memory=1g --cpus=1
        --volume /home/gebruiker/wordpress:/var/www/html
        --size 30g -p 80:80 wordpress
      loop:
        - "1"
        - "2"
        - "3"
        - "4"
        - "5"
        - "6"
        - "7"
        - "8"
        - "9"
        - "10"

    - name: Limiteer netwerksnelheid van container
      command: >
        docker exec -it my_wordpress_container_{{ item }}
        /sbin/tc qdisc add dev eth0 root tbf rate 50mbit burst 10kbit latency 50ms
      loop:
        - "1"
        - "2"
        - "3"
        - "4"
        - "5"
        - "6"
        - "7"
        - "8"
        - "9"
        - "10"

    - name: Genereren van SSL-certificaten...
      command: >
        openssl req -x509 -nodes -newkey rsa:4096
        -keyout /etc/ssl/certificaten/key.pem
        -out /etc/ssl/certificaten/cert.pem
      args:
        creates: /etc/ssl/certificaten/

    - name: Voeg gebruikers toe aan de containers
      shell: >
        docker exec -it wordpress_container_{{ item }} /bin/bash -c "
        adduser gebruiker1 &&
        adduser gebruiker2 &&
        openssl req -x509 -nodes -newkey rsa:4096 -keyout /home/gebruiker1/key.pem -out /home/gebruiker1/cert.pem &&
        openssl req -x509 -nodes -newkey rsa:4096 -keyout /home/gebruiker2/key.pem -out /home/gebruiker2/cert.pem
        "
      loop:
        - "1"
        - "2"
        - "3"
        - "4"
        - "5"
        - "6"
        - "7"
        - "8"
        - "9"
        - "10"

- name: firewall-script uitvoeren voor in de containers
  hosts: pm01
  tasks:
    - name: Kopieer firewall-script naar de containers
      copy:
        src: /home/geenboom1/ansible_wordpress_project/firewall_script.sh
        dest: /tmp/firewall_script.sh

    - name: Voer het firewall-script uit
      command: docker exec -it wordpress_container_{{ item }} /bin/bash -c "/tmp/firewall_script.sh"
      loop:
        - "1"
        - "2"
        - "3"
        - "4"
        - "5"
        - "6"
        - "7"
        - "8"
        - "9"
        - "10"
